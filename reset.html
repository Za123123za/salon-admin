<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>รีเซ็ตรหัสผ่าน</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f6f8fa;margin:0}
    .wrap{max-width:480px;margin:40px auto;padding:16px}
    .card{background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:20px}
    h2{margin:0 0 10px 0}
    .muted{color:#6b7280}
    input,button{width:100%;padding:12px;border-radius:10px;border:1px solid #e5e7eb;margin:8px 0}
    button{background:#00acc1;color:#fff;border:0;font-weight:700;cursor:pointer}
    #msg{margin-top:8px;font-size:14px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>ตั้งรหัสผ่านใหม่</h2>
      <p class="muted">กรอกรหัสผ่านใหม่ 2 ครั้ง แล้วกดยืนยัน</p>
      <input id="pass1" type="password" placeholder="รหัสผ่านใหม่" />
      <input id="pass2" type="password" placeholder="ยืนยันรหัสผ่านใหม่" />
      <button id="btn">ยืนยันการเปลี่ยนรหัสผ่าน</button>
      <div id="msg" class="muted"></div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ใช้ค่าจริงของโปรเจกต์เดียวกับที่แอป Flutter ใช้
  const SUPABASE_URL = 'https://cnvrzvqpnvogbibrxhnh.supabase.co';
  const SUPABASE_ANON_KEY = 'YOUR_ANON_KEY';

  const sb  = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const $   = (id)=>document.getElementById(id);
  const msg = (t, ok=true)=>{ const el=$('msg'); el.textContent=t; el.style.color=ok?'#6b7280':'#b91c1c'; };
  const btn = $('btn');

  btn.disabled = true;

  async function bootstrapSession() {
    try {
      const url = new URL(window.location.href);

      // ลิงก์ของ Supabase อาจมาหลายรูปแบบ → รองรับทั้งหมด
      // 1) ?code=xxxxx        (PKCE)
      // 2) ?token_hash=xxxxx  (บางธีมเมล/เวอร์ชันเก่า)
      // 3) #access_token=...&refresh_token=... (implicit)
      const codeFromQuery  = url.searchParams.get('code') || url.searchParams.get('token_hash');
      const hashParams     = new URLSearchParams(window.location.hash.slice(1));
      const accessToken    = hashParams.get('access_token');
      const refreshToken   = hashParams.get('refresh_token');

      if (codeFromQuery) {
        // ลิงก์กู้รหัสผ่านแบบ PKCE
        const { error } = await sb.auth.verifyOtp({
          type: 'recovery',
          token_hash: codeFromQuery
        });
        if (error) throw error;
      } else if (accessToken && refreshToken) {
        // ลิงก์แบบ implicit (รุ่นเก่า)
        const { error } = await sb.auth.setSession({
          access_token: accessToken,
          refresh_token: refreshToken,
        });
        if (error) throw error;
      } else {
        msg('ลิงก์ไม่ถูกต้องหรือหมดอายุ กรุณากด “ลืมรหัสผ่าน” ใหม่จากแอป', false);
        return;
      }

      // ตรวจว่ามี session แล้ว
      const { data } = await sb.auth.getSession();
      if (!data?.session) {
        msg('ยังไม่มีเซสชันจากลิงก์ กรุณากด “ลืมรหัสผ่าน” ใหม่อีกครั้ง', false);
        return;
      }

      btn.disabled = false;
      msg('โปรดตั้งรหัสผ่านใหม่');
    } catch (e) {
      console.error('bootstrap error:', e);
      msg('ไม่สามารถตั้งค่าเซสชันจากลิงก์ได้: ' + (e.message || e), false);
    }
  }

  bootstrapSession();

  // เปลี่ยนรหัสผ่าน
  btn.addEventListener('click', async () => {
    const p1 = $('pass1').value.trim();
    const p2 = $('pass2').value.trim();
    if (!p1 || !p2) return msg('กรุณากรอกรหัสผ่านให้ครบ', false);
    if (p1.length < 6) return msg('รหัสผ่านควรยาวอย่างน้อย 6 ตัวอักษร', false);
    if (p1 !== p2) return msg('รหัสผ่านทั้งสองช่องไม่ตรงกัน', false);

    try {
      const { error } = await sb.auth.updateUser({ password: p1 });
      if (error) throw error;
      msg('เปลี่ยนรหัสผ่านสำเร็จ! กลับไปที่แอปแล้วเข้าสู่ระบบใหม่ได้เลย ✅');
    } catch (e) {
      console.error('updateUser error:', e);
      msg('เปลี่ยนรหัสผ่านไม่สำเร็จ: ' + (e.message || e), false);
    }
  });
</script>

</body>
</html>
