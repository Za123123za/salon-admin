<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard</title>
  <style>
    :root{--teal:#00acc1;--bg:#f6f8fa;--card:#fff;--text:#111;--muted:#6b7280}
    *{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    body{margin:0;background:var(--bg);color:var(--text)}
    header{display:flex;gap:12px;justify-content:space-between;align-items:center;padding:16px 20px;background:var(--teal);color:#fff}
    .wrap{max-width:1100px;margin:18px auto;padding:0 14px}
    .card{background:var(--card);border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:16px;margin-bottom:16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .btn{border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn-ghost{background:#eef3f6;color:#111}
    input,select,button{padding:10px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#fff}
    .muted{color:var(--muted)} .hidden{display:none}

    .badge{display:inline-flex;align-items:center;gap:6px;padding:5px 9px;border-radius:999px;font-size:12px}
    .b-booked{background:#fff7ed;color:#b45309}
    .b-in_service{background:#eef2ff;color:#3730a3}
    .b-paid{background:#ecfdf5;color:#065f46}
    .b-cancelled{background:#fef2f2;color:#b91c1c}

    .cards{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:720px){ .cards{grid-template-columns:1fr 1fr} }
    @media (min-width:1024px){ .cards{grid-template-columns:1fr 1fr 1fr} }

    .booking-card{background:#fff;border-radius:14px;box-shadow:0 8px 22px rgba(0,0,0,.06);padding:14px;display:flex;flex-direction:column;gap:10px}
    .card-head{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .card-time{font-weight:800}
    .card-body{display:flex;flex-direction:column;gap:6px}
    .kv{display:flex;gap:8px;align-items:flex-start}
    .kv .k{min-width:56px;color:var(--muted);font-size:12px}
    .kv .v{font-weight:600}
    .card-foot{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .statusSel{flex:1 1 auto}

    .group-title{display:flex;align-items:center;justify-content:space-between;margin:6px 2px 10px 2px}
    .group-title h4{margin:0;font-size:16px}
    .pill{background:#eef3f6;border-radius:999px;padding:4px 8px;font-size:12px}

    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{padding:10px 12px;text-align:left;background:#fff}
    tr td:first-child,tr th:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    tr td:last-child,tr th:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}

    .tabs{display:flex;gap:8px;margin-bottom:8px}
    .tabs button{padding:8px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
    .tabs button.active{background:var(--teal);color:#fff;border-color:var(--teal)}

    .login{max-width:420px;margin:40px auto}
    #sysMsg{margin:10px 0;color:#b91c1c;font-size:13px}
    #toast{position:fixed;right:16px;bottom:16px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transition:opacity .25s}
    #toast.show{opacity:1}

    /* ====== Chats (full page) ====== */
    #chatsLayout{display:grid;grid-template-columns:280px 1fr;gap:14px;min-height:540px}
    #chatList{background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);overflow:auto}
    .cl-head{padding:12px;border-bottom:1px solid #eef2f7;font-weight:700}
    .cl-item{display:flex;gap:10px;align-items:center;padding:10px 12px;border-bottom:1px solid #f2f4f7;cursor:pointer}
    .cl-item:hover{background:#f9fbfc}
    .cl-name{font-weight:700}
    .cl-snippet{font-size:12px;color:#6b7280}
    .cl-time{margin-left:auto;font-size:12px;color:#9ca3af}
    .selected{background:#eef8fb}
    #chatView{background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);display:flex;flex-direction:column}
    #chatHeader{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #eef2f7}
    #chatMessages{flex:1 1 auto;overflow:auto;padding:10px;background:#f6f8fa}
    #chatComposer{display:flex;gap:8px;padding:10px;border-top:1px solid #eef2f7}
    #chatComposer input{flex:1 1 auto}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
</head>
<body>
<header>
  <div class="row">
    <strong>Admin Dashboard</strong>
    <span id="adminName" class="muted"></span>
  </div>
  <div class="row">
    <button id="btnSignOut" class="btn btn-ghost hidden" type="button">ออกจากระบบ</button>
  </div>
</header>

<div class="wrap">
  <!-- LOGIN -->
  <div id="loginSection" class="card login">
    <h3 style="margin:0 0 10px 0;">เข้าสู่ระบบแอดมิน</h3>
    <p class="muted" style="margin-top:0">กรอกอีเมล/รหัสผ่านบัญชีแอดมิน</p>
    <div id="sysMsg" class="hidden"></div>
    <div class="row">
      <input id="email" type="email" placeholder="อีเมล" style="flex:1 1 220px" />
      <input id="password" type="password" placeholder="รหัสผ่าน" style="flex:1 1 180px" />
      <button id="btnLogin" class="btn btn-ghost" type="button">เข้าสู่ระบบ</button>
    </div>
    <p id="loginMsg" class="muted" style="margin-top:10px"></p>
  </div>

  <!-- APP -->
  <div id="appSection" class="hidden">
    <div class="tabs">
      <button id="tabBookings" class="active" type="button">คิวช่วง 30 วัน</button>
      <button id="tabCustomers" type="button">ผู้ใช้</button>
      <button id="tabChats" type="button">แชท</button>
    </div>

    <!-- BOOKINGS -->
    <section id="bookingsPanel" class="card">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">คิวช่วง 30 วัน</h3>
        <div class="row">
          <input id="searchBooking" placeholder="ค้นหา: ลูกค้า/บริการ/ช่าง/ที่อยู่" />
          <button id="btnClearFilter" class="btn btn-ghost" type="button" title="ล้างตัวกรองผู้ใช้">ล้างกรอง</button>
          <button id="btnReload" class="btn btn-ghost" type="button">รีเฟรช</button>
        </div>
      </div>
      <div style="height:10px"></div>
      <div class="muted" id="rangeText"></div>
      <div style="height:10px"></div>

      <div class="card">
        <div class="group-title">
          <h4>จองแล้ว</h4>
          <span class="pill" id="countBooked">0 รายการ</span>
        </div>
        <div id="groupBooked" class="cards"></div>
      </div>

      <div class="card">
        <div class="group-title">
          <h4>ผู้ใช้เข้าใช้บริการ</h4>
          <span class="pill" id="countInService">0 รายการ</span>
        </div>
        <div id="groupInService" class="cards"></div>
      </div>

      <div class="card">
        <div class="group-title">
          <h4>ผู้ใช้ชำระเงินแล้ว</h4>
          <span class="pill" id="countPaid">0 รายการ</span>
        </div>
        <div id="groupPaid" class="cards"></div>
      </div>
    </section>

    <!-- CUSTOMERS -->
    <section id="customersPanel" class="card hidden">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">ผู้ใช้</h3>
        <input id="searchCustomer" placeholder="ค้นหา: ชื่อผู้ใช้" />
      </div>
      <div style="height:10px"></div>
      <div class="card">
        <table>
          <thead>
            <tr><th>ผู้ใช้</th><th>สิทธิ์</th><th>สมัครเมื่อ</th><th></th></tr>
          </thead>
          <tbody id="customerRows"></tbody>
        </table>
      </div>
    </section>

    <!-- CHATS -->
    <section id="chatsPanel" class="hidden">
      <div id="chatsLayout">
        <div id="chatList">
          <div class="cl-head">ผู้ใช้ที่คุยด้วย</div>
          <div id="chatListItems"></div>
        </div>
        <div id="chatView">
          <div id="chatHeader">
            <strong id="chatTitle">เลือกผู้ใช้ทางซ้ายเพื่อเริ่มคุย</strong>
            <span id="chatHeaderRight" class="muted"></span>
          </div>
          <div id="chatMessages"></div>
          <div id="chatComposer">
            <input id="chatInput" placeholder="พิมพ์ข้อความ..." />
            <button class="btn" type="button" id="btnSend">ส่ง</button>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>

<div id="toast"></div>

<script>
  // ====== CONFIG ======
  const SUPABASE_URL = 'https://cnvrzvqpnvogbibrxhnh.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNudnJ6dnFwbnZvZ2JpYnJ4aG5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NjMzNTAsImV4cCI6MjA3MDAzOTM1MH0.HI92YCd9UF8Nzn0Lq-uWGF21Iz7zqwAHY6PBesQ4cu4';

  // ====== Utils ======
  const $ = (id)=>document.getElementById(id);
  const sysBox = $('sysMsg');
  const showSys = (msg)=>{ sysBox.textContent = msg; sysBox.classList.remove('hidden'); };
  const hideSys = ()=>{ sysBox.classList.add('hidden'); };
  const toast = (msg, ok=true)=>{
    const el = $('toast');
    el.textContent = msg;
    el.style.background = ok ? 'rgba(17,17,17,.9)' : '#b91c1c';
    el.classList.add('show');
    setTimeout(()=>el.classList.remove('show'), 2000);
  };

  const STATUS_LABELS = { booked:'จองแล้ว', in_service:'ผู้ใช้เข้าใช้บริการ', paid:'ผู้ใช้ชำระเงินแล้ว', cancelled:'ยกเลิก' };
  const STATUS_CLASS  = { booked:'b-booked', in_service:'b-in_service', paid:'b-paid', cancelled:'b-cancelled' };

  let sb = null;
  let filterUserId = null;

  window.addEventListener('DOMContentLoaded', () => {
    sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    bindEvents();
    autoLoginIfSession();
  });

  function bindEvents(){
    $('btnLogin').addEventListener('click', onLogin);
    $('btnSignOut').addEventListener('click', onSignOut);
    $('tabBookings').addEventListener('click', ()=>setTab('bookings'));
    $('tabCustomers').addEventListener('click', ()=>setTab('customers'));
    $('tabChats').addEventListener('click', ()=>setTab('chats'));
    $('btnReload').addEventListener('click', loadBookings30d);
    $('btnClearFilter').addEventListener('click', ()=>{ filterUserId=null; renderBookings(); toast('ล้างตัวกรองผู้ใช้แล้ว'); });
    $('searchBooking').addEventListener('input', renderBookings);
    $('searchCustomer').addEventListener('input', renderCustomers);
    $('btnSend').addEventListener('click', sendChat);

    // เปลี่ยนสถานะ booking (delegation)
    document.body.addEventListener('change', async (e)=>{
      const el = e.target;
      if (el && el.classList.contains('statusSel')) {
        const bookingId = el.getAttribute('data-bid');
        const newStatus = el.value;
        el.disabled = true;
        await onChangeStatus(bookingId, newStatus);
        el.disabled = false;
      }
    });
  }

  async function onLogin(){
    hideSys();
    const email = $('email').value.trim();
    const pass  = $('password').value;
       if (!email || !pass) { $('loginMsg').textContent = 'กรอกอีเมล/รหัสผ่านก่อน'; return; }
    $('loginMsg').textContent = 'กำลังเข้าสู่ระบบ...';
    const { error } = await sb.auth.signInWithPassword({ email, password: pass });
    if (error) { $('loginMsg').textContent = 'เข้าสู่ระบบไม่สำเร็จ: ' + error.message; return; }
    await initApp();
  }

  async function onSignOut(){
    await sb.auth.signOut();
    $('appSection').classList.add('hidden');
    $('loginSection').classList.remove('hidden');
    $('loginMsg').textContent = 'ออกจากระบบแล้ว';
    stopChatRealtime();
  }

  function setTab(which){
    const tabs = ['bookings','customers','chats'];
    for(const t of tabs){
      $('tab'+capitalize(t)).classList.toggle('active', t===which);
      $(t+'Panel').classList.toggle('hidden', t!==which);
    }
    if (which==='chats') loadConversations();
  }
  const capitalize = s=>s.charAt(0).toUpperCase()+s.slice(1);

  async function initApp(){
    const { data:{ user } } = await sb.auth.getUser();
    if(!user){ $('loginMsg').textContent='กรุณาเข้าสู่ระบบ'; return; }

    const { data: profile, error } =
      await sb.from('profiles').select('username,is_admin').eq('id', user.id).maybeSingle();

    if (error) { showSys('ดึงโปรไฟล์ไม่สำเร็จ: '+error.message); return; }
    if (!profile || !profile.is_admin) {
      $('loginMsg').textContent='ไม่มีสิทธิ์เข้าใช้งาน (ต้องเป็นแอดมิน)';
      await sb.auth.signOut(); return;
    }

    $('adminName').textContent = 'สวัสดี, ' + (profile.username || 'admin');
    $('btnSignOut').classList.remove('hidden');
    $('loginSection').classList.add('hidden');
    $('appSection').classList.remove('hidden');

    setTab('bookings');
    await Promise.all([loadBookings30d(), loadCustomers()]);
  }

  function getRange30d(){
    const from = new Date(); from.setHours(0,0,0,0);
    const to = new Date(from); to.setDate(to.getDate()+30);
    $('rangeText').textContent = `ช่วงเวลา: ${from.toLocaleDateString('th-TH')} 00:00 - ${to.toLocaleDateString('th-TH')} 00:00`;
    return {from,to};
  }

  let profilesMap = new Map(), bookingsRaw = [], customersRaw = [];

  async function loadBookings30d(){
    const { from, to } = getRange30d();

    // ⭐ เพิ่ม slip_url ใน select ด้วย
    let q = sb.from('bookings')
      .select('id,user_id,start_at,end_at,status,slip_url,services(name),staff(display_name)')
      .gte('start_at', from.toISOString())
      .lt('start_at', to.toISOString())
      .order('start_at', { ascending: true });

    if (filterUserId) q = q.eq('user_id', filterUserId);

    const { data: bookings, error } = await q;
    if (error) { showSys('โหลดคิวไม่สำเร็จ: '+error.message); return; }
    bookingsRaw = bookings || [];

    const uids = [...new Set(bookingsRaw.map(b=>b.user_id))];
    if(uids.length){
      const { data: profs } = await sb.from('profiles').select('id,username,address').in('id', uids);
      profilesMap = new Map((profs||[]).map(p=>[p.id,p]));
    }else{
      profilesMap = new Map();
    }

    renderBookings();
  }

  const statusOptions = [
    { value:'booked',     label: STATUS_LABELS.booked },
    { value:'in_service', label: STATUS_LABELS.in_service },
    { value:'paid',       label: STATUS_LABELS.paid },
  ];

  const fmtTime = iso => new Date(iso).toLocaleString('th-TH',{ day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit' });
  const badge = s => `<span class="badge ${STATUS_CLASS[s]||'b-booked'}">${STATUS_LABELS[s]||s}</span>`;

  function makeCard(b){
    const prof = profilesMap.get(b.user_id) || {};
    const name = prof.username || '—';
    const addr = prof.address || '—';
    const svc  = b.services?.name || '—';
    const stf  = b.staff?.display_name || '—';

    const sel = `
      <select data-bid="${b.id}" class="statusSel">
        ${statusOptions.map(op=>`<option value="${op.value}" ${op.value===b.status?'selected':''}>${op.label}</option>`).join('')}
      </select>
    `;

    const chatBtn = `<button class="btn btn-ghost" type="button" onclick="openChatTabAndWith('${b.user_id}','${(name||'ผู้ใช้').replace(/'/g,'\\&#39;')}')">แชท</button>`;

    // ⭐ ส่วนแสดงหลักฐานการโอน
    const slipPart = b.slip_url
      ? `<button class="btn btn-ghost" type="button" onclick="window.open('${b.slip_url}','_blank')">ดูสลิป</button>`
      : `<span class="muted" style="font-size:12px">ไม่มีหลักฐานโอน</span>`;

    return `
      <div class="booking-card" data-bid="${b.id}">
        <div class="card-head">
          <div class="card-time">${fmtTime(b.start_at)}</div>
          <div class="badge-wrap">${badge(b.status)}</div>
        </div>
        <div class="card-body">
          <div class="kv"><div class="k">ลูกค้า</div><div class="v">${name}</div></div>
          <div class="kv"><div class="k">บริการ</div><div class="v">${svc}</div></div>
          <div class="kv"><div class="k">ช่าง</div><div class="v">${stf}</div></div>
          <div class="kv"><div class="k">ที่อยู่</div><div class="v" style="font-weight:500;color:#374151">${addr}</div></div>
        </div>
        <div class="card-foot">
          <div class="row" style="gap:8px">
            <div class="muted" style="font-size:12px">เปลี่ยนสถานะ</div>
            ${sel}
          </div>
          <div class="row" style="gap:8px">
            ${slipPart}
            ${chatBtn}
          </div>
        </div>
      </div>
    `;
  }

  function renderBookings(){
    const q = ($('searchBooking').value||'').toLowerCase();

    const filtered = (bookingsRaw||[]).filter(b=>{
      const prof = profilesMap.get(b.user_id) || {};
      const name = prof.username || '';
      const addr = prof.address || '';
      const svc  = b.services?.name || '';
      const stf  = b.staff?.display_name || '';
      const okSearch = [name, svc, stf, addr].some(x => (x||'').toLowerCase().includes(q));
      const okFilter = filterUserId ? (b.user_id === filterUserId) : true;
      return okSearch && okFilter;
    });

    const listBooked = filtered.filter(b => b.status === 'booked');
    const listInSrv  = filtered.filter(b => b.status === 'in_service');
    const listPaid   = filtered.filter(b => b.status === 'paid');

    $('groupBooked').innerHTML    = listBooked.map(makeCard).join('') || `<div class="muted">— ว่าง —</div>`;
    $('groupInService').innerHTML = listInSrv.map(makeCard).join('')  || `<div class="muted">— ว่าง —</div>`;
    $('groupPaid').innerHTML      = listPaid.map(makeCard).join('')   || `<div class="muted">— ว่าง —</div>`;

    $('countBooked').textContent    = `${listBooked.length} รายการ`;
    $('countInService').textContent = `${listInSrv.length} รายการ`;
    $('countPaid').textContent      = `${listPaid.length} รายการ`;
  }

  async function onChangeStatus(bookingId, newStatus){
    try{
      const { error } = await sb.from('bookings').update({ status: newStatus }).eq('id', bookingId);
      if(error){ toast('อัปเดตสถานะไม่สำเร็จ: '+error.message, false); return; }
      bookingsRaw = bookingsRaw.map(b => b.id===bookingId ? ({...b, status:newStatus}) : b);
      renderBookings();
      toast('อัปเดตสถานะเรียบร้อย');
    }catch(e){
      toast('เกิดข้อผิดพลาด: '+e.message, false);
    }
  }

  // ===== Customers =====
  async function loadCustomers(){
    const { data: rows } = await sb.from('profiles').select('id,username,is_admin,created_at').order('created_at', { ascending:false });
    customersRaw = rows || []; renderCustomers();
  }

  function renderCustomers(){
    const q = ($('searchCustomer').value||'').toLowerCase();
    const rows = (customersRaw||[])
      .filter(p => (p.username||'').toLowerCase().includes(q))
      .map(p => `
        <tr>
          <td>${p.username||'—'}</td>
          <td>${p.is_admin?'Admin':'User'}</td>
          <td>${new Date(p.created_at).toLocaleDateString('th-TH')}</td>
          <td>
            <div class="row">
              <button class="btn" onclick="viewUserBookings('${p.id}')">ดูการจอง</button>
              <button class="btn btn-ghost" onclick="openChatTabAndWith('${p.id}','${(p.username||'ผู้ใช้').replace(/'/g,'\\&#39;')}')">แชท</button>
            </div>
          </td>
        </tr>
      `).join('');
    $('customerRows').innerHTML = rows || `<tr><td colspan="4" class="muted">— ไม่มีข้อมูล —</td></tr>`;
  }

  window.viewUserBookings = async (uid) => {
    filterUserId = uid;
    setTab('bookings');
    await loadBookings30d();
    toast('กรองการจองตามผู้ใช้แล้ว');
  };

  async function autoLoginIfSession(){
    const { data:{session} } = await sb.auth.getSession();
    if (session) initApp();
  }

  /* ======================= Chats (Full Page) ======================= */
  let chatPeerId = null;
  let chatPeerName = 'ผู้ใช้';
  let chatSubscription = null;

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
  }
  function computeChatId(a, b){ const ids=[a,b].sort(); return ids[0]+'_'+ids[1]; }
  function stopChatRealtime(){ if (chatSubscription){ chatSubscription.unsubscribe(); chatSubscription=null; } }

  function openChatTabAndWith(uid, name){
    setTab('chats');
    openChatWith(uid, name);
  }

  // ดึง “รายชื่อห้อง” โดยอ่านข้อความของแอดมิน แล้ว group ตามคู่สนทนา (peer)
  async function loadConversations(){
    const { data:{ user } } = await sb.auth.getUser();
    if(!user){ toast('กรุณาเข้าสู่ระบบใหม่', false); return; }

    // ดึงช่วง 90 วันหลังสุด (พอให้เห็นห้องที่มีการคุย)
    const since = new Date(); since.setDate(since.getDate()-90);

    const { data: rows, error } = await sb
      .from('messages')
      .select('chat_id,sender_id,receiver_id,content,created_at')
      .or(`sender_id.eq.${user.id},receiver_id.eq.${user.id}`)
      .gte('created_at', since.toISOString())
      .order('created_at', { ascending:false });

    if (error){ $('chatListItems').innerHTML = '<div class="muted" style="padding:12px">โหลดห้องไม่สำเร็จ</div>'; return; }

    // group by peer_id -> keep latest message per peer
    const byPeer = new Map();
    for(const m of (rows||[])){
      const peer = (m.sender_id===user.id) ? m.receiver_id : m.sender_id;
      if (!byPeer.has(peer)) byPeer.set(peer, m); // เก็บตัวล่าสุดตามที่ order แล้ว
    }

    // ดึงชื่อผู้ใช้ทั้งหมดของ peers
    const peers = [...byPeer.keys()];
    let nameMap = new Map();
    if (peers.length){
      const { data: profs } = await sb.from('profiles').select('id,username').in('id', peers);
      nameMap = new Map((profs||[]).map(p=>[p.id, p.username||'ผู้ใช้']));
    }

    // render list
    const items = peers.map(pid=>{
      const m = byPeer.get(pid);
      const name = nameMap.get(pid) || 'ผู้ใช้';
      const time = new Date(m.created_at).toLocaleString('th-TH',{ month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
      const snippet = (m.content||'').toString();
      const selected = (pid===chatPeerId) ? ' selected' : '';
      return `
        <div class="cl-item${selected}" onclick="openChatWith('${pid}','${(name).replace(/'/g,'\\&#39;')}')">
          <div>
            <div class="cl-name">${escapeHtml(name)}</div>
            <div class="cl-snippet">${escapeHtml(snippet)}</div>
          </div>
          <div class="cl-time">${time}</div>
        </div>
      `;
    }).join('');

    $('chatListItems').innerHTML = items || '<div class="muted" style="padding:12px">— ยังไม่มีการสนทนา —</div>';
  }

  async function openChatWith(peerId, peerName='ผู้ใช้'){
    try{
      const { data:{ user } } = await sb.auth.getUser();
      if(!user){ toast('กรุณาเข้าสู่ระบบใหม่', false); return; }

      chatPeerId = peerId; chatPeerName = peerName;
      $('chatTitle').textContent = `แชทกับ: ${peerName}`;
      $('chatHeaderRight').textContent = '';

      // เลือกใน list ให้เห็นเป็น active
      document.querySelectorAll('.cl-item').forEach(el=>el.classList.remove('selected'));
      const idx = [...document.querySelectorAll('.cl-item')].find(el => el.getAttribute('onclick')?.includes(peerId));
      if (idx) idx.classList.add('selected');

      stopChatRealtime();
      const chatId = computeChatId(user.id, peerId);

      // โหลดข้อความย้อนหลัง
      const { data: rows, error } = await sb
        .from('messages')
        .select('*')
        .eq('chat_id', chatId)
        .order('created_at', { ascending: true });

      if (error) { $('chatMessages').innerHTML = '<div class="muted" style="padding:12px">โหลดข้อความไม่สำเร็จ</div>'; return; }
      renderChatRows(rows || [], user.id);

      // subscribe realtime
      chatSubscription = sb
        .channel('realtime:messages:'+chatId)
        .on('postgres_changes',
          { event: 'INSERT', schema: 'public', table: 'messages', filter: `chat_id=eq.${chatId}` },
          payload => appendChatRow(payload.new, user.id)
        ).subscribe();

    }catch(e){
      console.error(e);
      toast('เปิดห้องแชทไม่สำเร็จ', false);
    }
  }

  function renderChatRows(rows, myId){
    const box = $('chatMessages');
    if(!rows.length){ box.innerHTML = '<div class="muted" style="padding:12px">— ยังไม่มีข้อความ —</div>'; return; }
    box.innerHTML = rows.map(m=>{
      const mine = m.sender_id === myId;
      return `
        <div style="display:flex; ${mine?'justify-content:flex-end':'justify-content:flex-start'}; margin:6px 0;">
          <div style="max-width:78%; padding:8px 12px; border-radius:12px; background:${mine?'#00acc1':'#e5e7eb'}; color:${mine?'#fff':'#111'}; white-space:pre-wrap; word-break:break-word;">
            ${escapeHtml(m.content||'')}
          </div>
        </div>
      `;
    }).join('');
    box.scrollTop = box.scrollHeight;
  }

  function appendChatRow(m, myId){
    const box = $('chatMessages');
    if (box.innerHTML.includes('ยังไม่มีข้อความ')) box.innerHTML = '';
    const mine = m.sender_id === myId;
    const html = `
      <div style="display:flex; ${mine?'justify-content:flex-end':'justify-content:flex-start'}; margin:6px 0;">
        <div style="max-width:78%; padding:8px 12px; border-radius:12px; background:${mine?'#00acc1':'#e5e7eb'}; color:${mine?'#fff':'#111'}; white-space:pre-wrap; word-break:break-word;">
          ${escapeHtml(m.content||'')}
        </div>
      </div>`;
    box.insertAdjacentHTML('beforeend', html);
    box.scrollTop = box.scrollHeight;

    // อัปเดตรายการแชทซ้ายให้ขึ้นบน (โหลดใหม่สั้น ๆ)
    loadConversations();
  }

  async function sendChat(){
    const txt = ($('chatInput').value||'').trim();
    if(!txt) return;
    const { data:{ user } } = await sb.auth.getUser();
    if(!user || !chatPeerId){ toast('ยังไม่มีห้องแชท', false); return; }
    const chatId = computeChatId(user.id, chatPeerId);

    $('chatInput').value = '';
    const { error } = await sb.from('messages').insert({
      chat_id: chatId,
      sender_id: user.id,
      receiver_id: chatPeerId,
      content: txt
    });
    if (error) toast('ส่งไม่สำเร็จ: '+error.message, false);
  }
</script>
</body>
</html>
