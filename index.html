<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard</title>
  <style>
    :root{--teal:#00acc1;--bg:#f6f8fa;--card:#fff;--text:#111;--muted:#6b7280}
    *{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    body{margin:0;background:var(--bg);color:var(--text)}
    header{display:flex;gap:12px;justify-content:space-between;align-items:center;padding:16px 20px;background:var(--teal);color:#fff}
    .wrap{max-width:1100px;margin:18px auto;padding:0 14px}
    .card{background:var(--card);border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:16px;margin-bottom:16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .btn{border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn-ghost{background:#eef3f6;color:#111}
    .btn-danger{background:#b91c1c;color:#fff}
    input,select,button{padding:10px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#fff}
    .muted{color:var(--muted)} .hidden{display:none}

    .badge{display:inline-flex;align-items:center;gap:6px;padding:5px 9px;border-radius:999px;font-size:12px}
    .b-booked{background:#fff7ed;color:#b45309}
    .b-in_service{background:#eef2ff;color:#3730a3}
    .b-paid{background:#ecfdf5;color:#065f46}
    .b-cancelled{background:#fef2f2;color:#b91c1c}

    .cards{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:720px){ .cards{grid-template-columns:1fr 1fr} }
    @media (min-width:1024px){ .cards{grid-template-columns:1fr 1fr 1fr} }

    .booking-card{background:#fff;border-radius:14px;box-shadow:0 8px 22px rgba(0,0,0,.06);padding:14px;display:flex;flex-direction:column;gap:10px}
    .card-head{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .card-time{font-weight:800}
    .card-body{display:flex;flex-direction:column;gap:6px}
    .kv{display:flex;gap:8px;align-items:flex-start}
    .kv .k{min-width:56px;color:var(--muted);font-size:12px}
    .kv .v{font-weight:600}
    .card-foot{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .statusSel{flex:1 1 auto}

    .group-title{display:flex;align-items:center;justify-content:space-between;margin:6px 2px 10px 2px}
    .group-title h4{margin:0;font-size:16px}
    .pill{background:#eef3f6;border-radius:999px;padding:4px 8px;font-size:12px}

    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{padding:10px 12px;text-align:left;background:#fff}
    tr td:first-child,tr th:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    tr td:last-child,tr th:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}

    .tabs{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
    .tabs button{padding:8px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
    .tabs button.active{background:var(--teal);color:#fff;border-color:var(--teal)}

    .login{max-width:420px;margin:40px auto}
    #sysMsg{margin:10px 0;color:#b91c1c;font-size:13px}
    #toast{position:fixed;right:16px;bottom:16px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transition:opacity .25s}
    #toast.show{opacity:1}

    /* ====== Chats ====== */
    #chatsLayout{display:grid;grid-template-columns:280px 1fr;gap:14px;min-height:540px}
    #chatList{background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);overflow:auto}
    .cl-head{padding:12px;border-bottom:1px solid #eef2f7;font-weight:700}
    .cl-item{display:flex;gap:10px;align-items:center;padding:10px 12px;border-bottom:1px solid #f2f4f7;cursor:pointer}
    .cl-item:hover{background:#f9fbfc}
    .cl-name{font-weight:700}
    .cl-snippet{font-size:12px;color:#6b7280}
    .cl-time{margin-left:auto;font-size:12px;color:#9ca3af}
    .selected{background:#eef8fb}
    #chatView{background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);display:flex;flex-direction:column}
    #chatHeader{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #eef2f7}
    #chatMessages{flex:1 1 auto;overflow:auto;padding:10px;background:#f6f8fa}
    #chatComposer{display:flex;gap:8px;padding:10px;border-top:1px solid #eef2f7;align-items:center}
    #chatComposer input{flex:1 1 auto}

    /* bubble image */
    .chat-img{
      max-width:260px;
      border-radius:12px;
      display:block;
      cursor:pointer;
    }

    /* ===== Gallery ===== */
    #galleryControls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:12px}
    #galleryGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
    .g-item{background:#fff;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.05);padding:8px;display:flex;flex-direction:column;gap:6px}
    .g-item img{width:100%;border-radius:8px;object-fit:cover;aspect-ratio:3/4}
    .g-item button{align-self:flex-end}

    /* ===== Reviews ===== */
    .review-grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:840px){ .review-grid{grid-template-columns:1fr 1fr} }
    .review-card{background:#fff;border-radius:14px;box-shadow:0 8px 22px rgba(0,0,0,.06);padding:14px;display:flex;flex-direction:column;gap:10px}
    .review-head{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .review-name{font-weight:800}
    .review-meta{color:#9ca3af;font-size:12px}
    .stars{color:#f59e0b;letter-spacing:1px}
    .review-comment{white-space:pre-wrap;word-break:break-word}
    .review-imgs{display:flex;gap:8px;flex-wrap:wrap}
    .review-imgs img{width:84px;height:84px;border-radius:10px;object-fit:cover;background:#f3f4f6}

    /* ===== Payments ===== */
    .stat-grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:900px){ .stat-grid{grid-template-columns:1.1fr .9fr} }
    .stat-card{background:#fff;border-radius:14px;box-shadow:0 8px 22px rgba(0,0,0,.06);padding:14px}
    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .kpi .box{background:#f8fafc;border:1px solid #eef2f7;border-radius:12px;padding:12px}
    .kpi .label{font-size:12px;color:#6b7280}
    .kpi .value{font-size:20px;font-weight:800;margin-top:6px}
    .small{font-size:12px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
</head>
<body>
<header>
  <div class="row">
    <strong>Admin Dashboard</strong>
    <span id="adminName" class="muted"></span>
  </div>
  <div class="row">
    <button id="btnSignOut" class="btn btn-ghost hidden" type="button">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
  </div>
</header>

<div class="wrap">
  <!-- LOGIN -->
  <div id="loginSection" class="card login">
    <h3 style="margin:0 0 10px 0;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h3>
    <p class="muted" style="margin-top:0">‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•/‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</p>
    <div id="sysMsg" class="hidden"></div>
    <div class="row">
      <input id="email" type="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" style="flex:1 1 220px" />
      <input id="password" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" style="flex:1 1 180px" />
      <button id="btnLogin" class="btn btn-ghost" type="button">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
    <p id="loginMsg" class="muted" style="margin-top:10px"></p>
  </div>

  <!-- APP -->
  <div id="appSection" class="hidden">
    <div class="tabs">
      <button id="tabBookings" class="active" type="button">‡∏Ñ‡∏¥‡∏ß‡∏ä‡πà‡∏ß‡∏á 30 ‡∏ß‡∏±‡∏ô</button>
      <button id="tabPayments" type="button">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢/‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
      <button id="tabCustomers" type="button">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
      <button id="tabChats" type="button">‡πÅ‡∏ä‡∏ó</button>
      <button id="tabGallery" type="button">‡∏£‡∏π‡∏õ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
      <button id="tabReviews" type="button">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</button>
    </div>

    <!-- BOOKINGS -->
    <section id="bookingsPanel" class="card">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">‡∏Ñ‡∏¥‡∏ß‡∏ä‡πà‡∏ß‡∏á 30 ‡∏ß‡∏±‡∏ô</h3>
        <div class="row">
          <input id="searchBooking" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£/‡∏ä‡πà‡∏≤‡∏á/‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà" />
          <button id="btnClearFilter" class="btn btn-ghost" type="button" title="‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≠‡∏á</button>
          <button id="btnReload" class="btn btn-ghost" type="button">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        </div>
      </div>
      <div style="height:10px"></div>
      <div class="muted" id="rangeText"></div>
      <div style="height:10px"></div>

      <div class="card">
        <div class="group-title">
          <h4>‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</h4>
          <span class="pill" id="countBooked">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
        </div>
        <div id="groupBooked" class="cards"></div>
      </div>

      <div class="card">
        <div class="group-title">
          <h4>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h4>
          <span class="pill" id="countInService">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
        </div>
        <div id="groupInService" class="cards"></div>
      </div>

      <div class="card">
        <div class="group-title">
          <h4>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß</h4>
          <span class="pill" id="countPaid">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
        </div>
        <div class="muted small" style="margin:-2px 2px 10px 2px">
          * ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß‚Äù ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á payments ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÉ‡∏ä‡πâ‡∏ó‡∏≥‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏¥‡∏¢‡∏°)
        </div>
        <div id="groupPaid" class="cards"></div>
      </div>
    </section>

    <!-- PAYMENTS / SALES -->
    <section id="paymentsPanel" class="card hidden">
      <div class="row" style="justify-content:space-between">
        <div>
          <h3 style="margin:0">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢/‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
          <div class="muted" style="margin-top:4px">‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á <b>payments</b> (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß)</div>
        </div>
        <div class="row">
          <select id="monthPick"></select>
          <button id="btnReloadPayments" class="btn btn-ghost" type="button">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="stat-grid">
        <div class="stat-card">
          <div class="group-title" style="margin:0 0 10px 0">
            <h4>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</h4>
            <span class="pill" id="paymentsCount">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
          </div>

          <div class="kpi" style="margin-bottom:12px">
            <div class="box">
              <div class="label">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
              <div class="value" id="kpiNet">‡∏ø0</div>
              <div class="muted small" id="kpiHint">‚Äî</div>
            </div>
            <div class="box">
              <div class="label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏•‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
              <div class="value" id="kpiBills">0</div>
              <div class="muted small">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>
            </div>
          </div>

          <div class="card" style="padding:10px">
            <table>
              <thead>
                <tr>
                  <th>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                  <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏•</th>
                  <th>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏ö‡∏≤‡∏ó)</th>
                </tr>
              </thead>
              <tbody id="salesRows"></tbody>
            </table>
          </div>
        </div>

        <div class="stat-card">
          <div class="group-title" style="margin:0 0 10px 0">
            <h4>‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏° (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</h4>
            <span class="pill" id="topSvcCount">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
          </div>

          <div class="card" style="padding:10px">
            <table>
              <thead>
                <tr>
                  <th>‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th>
                  <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                  <th>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
                </tr>
              </thead>
              <tbody id="topServiceRows"></tbody>
            </table>
          </div>

          <div class="muted small" style="margin-top:10px">
            * ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏¥‡∏¢‡∏°‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ‚Äú‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß‚Äù ‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏±‡πâ‡∏ô
          </div>
        </div>
      </div>
    </section>

    <!-- CUSTOMERS -->
    <section id="customersPanel" class="card hidden">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h3>
        <input id="searchCustomer" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" />
      </div>
      <div style="height:10px"></div>
      <div class="card">
        <table>
          <thead>
            <tr><th>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th><th>‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</th><th>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠</th><th></th></tr>
          </thead>
          <tbody id="customerRows"></tbody>
        </table>
      </div>
    </section>

    <!-- CHATS -->
    <section id="chatsPanel" class="hidden">
      <div id="chatsLayout">
        <div id="chatList">
          <div class="cl-head">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏¢‡∏î‡πâ‡∏ß‡∏¢</div>
          <div id="chatListItems"></div>
        </div>
        <div id="chatView">
          <div id="chatHeader">
            <strong id="chatTitle">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏∏‡∏¢</strong>
            <span id="chatHeaderRight" class="muted"></span>
          </div>
          <div id="chatMessages"></div>

          <div id="chatComposer">
            <input id="chatInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." />
            <input id="chatImage" type="file" accept="image/*" class="hidden" />
            <button class="btn btn-ghost" type="button" id="btnPickImage">üì∑</button>
            <button class="btn" type="button" id="btnSend">‡∏™‡πà‡∏á</button>
          </div>
          <div id="chatImageHint" class="muted small" style="padding:0 12px 12px 12px; display:none;"></div>
        </div>
      </div>
    </section>

    <!-- GALLERY PANEL -->
    <section id="galleryPanel" class="card hidden">
      <h3 style="margin-top:0">‡∏£‡∏π‡∏õ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h3>
      <p class="muted" style="margin-top:4px;margin-bottom:10px">
        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î ‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î/‡∏•‡∏ö‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ ‡∏£‡∏π‡∏õ‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ haircut, nail ‡∏Ø‡∏•‡∏Ø
      </p>

      <div id="galleryControls">
        <select id="galleryCategory"></select>
        <input id="galleryFile" type="file" accept="image/*" multiple />
        <button id="btnUploadGallery" class="btn" type="button">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ</button>
        <span id="galleryStatus" class="muted"></span>
      </div>

      <div id="galleryGrid"></div>
    </section>

    <!-- REVIEWS PANEL -->
    <section id="reviewsPanel" class="card hidden">
      <div class="row" style="justify-content:space-between">
        <div>
          <h3 style="margin:0">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
          <div class="muted" id="reviewsCount" style="margin-top:4px">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
        </div>
        <div class="row">
          <input id="searchReviews" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡∏ä‡∏∑‡πà‡∏≠/‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°" />
          <button id="btnReloadReviews" class="btn btn-ghost" type="button">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        </div>
      </div>
      <div style="height:12px"></div>
      <div id="reviewsGrid" class="review-grid"></div>
    </section>
  </div>
</div>

<div id="toast"></div>

<script>
  // ====== CONFIG ======
  const SUPABASE_URL = 'https://cnvrzvqpnvogbibrxhnh.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNudnJ6dnFwbnZvZ2JpYnJ4aG5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NjMzNTAsImV4cCI6MjA3MDAzOTM1MH0.HI92YCd9UF8Nzn0Lq-uWGF21Iz7zqwAHY6PBesQ4cu4';

  const GALLERY_CATEGORIES = [
    { id: 'haircut_short',     label: '‡∏ï‡∏±‡∏î‡∏ú‡∏°‡∏´‡∏ç‡∏¥‡∏á - ‡∏ú‡∏°‡∏™‡∏±‡πâ‡∏ô' },
    { id: 'haircut_long',      label: '‡∏ï‡∏±‡∏î‡∏ú‡∏°‡∏´‡∏ç‡∏¥‡∏á - ‡∏ú‡∏°‡∏¢‡∏≤‡∏ß' },
    { id: 'haircutmen_short',  label: '‡∏ï‡∏±‡∏î‡∏ú‡∏°‡∏ä‡∏≤‡∏¢ - ‡∏ú‡∏°‡∏™‡∏±‡πâ‡∏ô' },
    { id: 'haircutmen_long',   label: '‡∏ï‡∏±‡∏î‡∏ú‡∏°‡∏ä‡∏≤‡∏¢ - ‡∏ú‡∏°‡∏¢‡∏≤‡∏ß' },
    { id: 'nail',              label: '‡∏ó‡∏≥‡πÄ‡∏•‡πá‡∏ö' },
    { id: 'haircolor',         label: '‡∏ó‡∏≥‡∏™‡∏µ‡∏ú‡∏°' },
    { id: 'makeup',            label: '‡πÄ‡∏°‡∏Ñ‡∏≠‡∏±‡∏û' },
    { id: 'spa',               label: '‡∏™‡∏õ‡∏≤' },
    { id: 'eyelash',           label: '‡∏ï‡πà‡∏≠‡∏Ç‡∏ô‡∏ï‡∏≤' },
  ];

  const PRICE_FALLBACK = {
    '‡∏ï‡∏±‡∏î‡∏ú‡∏°‡∏´‡∏ç‡∏¥‡∏á - ‡∏ú‡∏°‡∏™‡∏±‡πâ‡∏ô': 250,
    '‡∏ï‡∏±‡∏î‡∏ú‡∏°‡∏´‡∏ç‡∏¥‡∏á - ‡∏ú‡∏°‡∏¢‡∏≤‡∏ß':  300,
    '‡∏ï‡∏±‡∏î‡∏ú‡∏°‡∏ä‡∏≤‡∏¢ - ‡∏ú‡∏°‡∏™‡∏±‡πâ‡∏ô':  200,
    '‡∏ï‡∏±‡∏î‡∏ú‡∏°‡∏ä‡∏≤‡∏¢ - ‡∏ú‡∏°‡∏¢‡∏≤‡∏ß':   250,
    '‡∏ó‡∏≥‡πÄ‡∏•‡πá‡∏ö':              350,
    '‡∏ó‡∏≥‡∏™‡∏µ‡∏ú‡∏°':              900,
    '‡πÄ‡∏°‡∏Ñ‡∏≠‡∏±‡∏û':              800,
    '‡∏™‡∏õ‡∏≤':                 600,
    '‡∏ï‡πà‡∏≠‡∏Ç‡∏ô‡∏ï‡∏≤':             700,
  };
  const DEFAULT_DEPOSIT = 100;

  const $ = (id)=>document.getElementById(id);
  const sysBox = $('sysMsg');
  const showSys = (msg)=>{ sysBox.textContent = msg; sysBox.classList.remove('hidden'); };
  const hideSys = ()=>{ sysBox.classList.add('hidden'); };
  const toast = (msg, ok=true)=>{
    const el = $('toast');
    el.textContent = msg;
    el.style.background = ok ? 'rgba(17,17,17,.9)' : '#b91c1c';
    el.classList.add('show');
    setTimeout(()=>el.classList.remove('show'), 2000);
  };

  const money = (n)=>{
    const v = Number(n||0);
    return '‡∏ø' + v.toLocaleString('th-TH', { maximumFractionDigits: 2 });
  };

  const STATUS_LABELS = { booked:'‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß', in_service:'‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£', paid:'‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß', cancelled:'‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' };
  const STATUS_CLASS  = { booked:'b-booked', in_service:'b-in_service', paid:'b-paid', cancelled:'b-cancelled' };

  let sb = null;
  let filterUserId = null;

  let galleryItems = [];
  let galleryCategoryId = GALLERY_CATEGORIES[0].id;

  let reviewsRaw = [];
  let paymentsRaw = [];

  // ===== Chats state (image) =====
  let pendingChatImageFile = null;

  window.addEventListener('DOMContentLoaded', () => {
    sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    bindEvents();
    initGalleryUI();
    initMonthPicker();
    autoLoginIfSession();
  });

  function bindEvents(){
    $('btnLogin').addEventListener('click', onLogin);
    $('btnSignOut').addEventListener('click', onSignOut);
    $('tabBookings').addEventListener('click', ()=>setTab('bookings'));
    $('tabPayments').addEventListener('click', ()=>setTab('payments'));
    $('tabCustomers').addEventListener('click', ()=>setTab('customers'));
    $('tabChats').addEventListener('click', ()=>setTab('chats'));
    $('tabGallery').addEventListener('click', ()=>setTab('gallery'));
    $('tabReviews').addEventListener('click', ()=>setTab('reviews'));

    $('btnReload').addEventListener('click', loadBookings30d);
    $('btnClearFilter').addEventListener('click', ()=>{ filterUserId=null; renderBookings(); toast('‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß'); });
    $('searchBooking').addEventListener('input', renderBookings);
    $('searchCustomer').addEventListener('input', renderCustomers);

    // chat buttons
    $('btnSend').addEventListener('click', sendChat);
    $('btnPickImage').addEventListener('click', ()=>$('chatImage').click());
    $('chatImage').addEventListener('change', onPickChatImage);

    // payments
    $('btnReloadPayments').addEventListener('click', loadPayments12m);
    $('monthPick').addEventListener('change', renderPaymentsDashboard);

    // gallery
    $('galleryCategory').addEventListener('change', e => {
      galleryCategoryId = e.target.value;
      loadGallery();
    });
    $('btnUploadGallery').addEventListener('click', uploadGalleryImages);

    // reviews
    $('btnReloadReviews').addEventListener('click', loadReviews);
    $('searchReviews').addEventListener('input', renderReviews);

    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ booking
    document.body.addEventListener('change', async (e)=>{
      const el = e.target;
      if (el && el.classList.contains('statusSel')) {
        const bookingId = el.getAttribute('data-bid');
        const newStatus = el.value;
        el.disabled = true;
        await onChangeStatus(bookingId, newStatus);
        el.disabled = false;
      }
    });

    // delete review
    document.body.addEventListener('click', async (e)=>{
      const el = e.target;
      if (el && el.dataset && el.dataset.action === 'deleteReview') {
        const rid = el.dataset.rid;
        await deleteReview(rid);
      }
    });
  }

  function setTab(which){
    const tabs = ['bookings','payments','customers','chats','gallery','reviews'];
    for(const t of tabs){
      $('tab'+capitalize(t)).classList.toggle('active', t===which);
      $(t+'Panel').classList.toggle('hidden', t!==which);
    }
    if (which==='chats') loadConversations();
    if (which==='gallery') loadGallery();
    if (which==='reviews') loadReviews();
    if (which==='payments') loadPayments12m();
  }
  const capitalize = s=>s.charAt(0).toUpperCase()+s.slice(1);

  async function onLogin(){
    hideSys();
    const email = $('email').value.trim();
    const pass  = $('password').value;
    if (!email || !pass) { $('loginMsg').textContent = '‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•/‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô'; return; }
    $('loginMsg').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';
    const { error } = await sb.auth.signInWithPassword({ email, password: pass });
    if (error) { $('loginMsg').textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message; return; }
    await initApp();
  }

  async function onSignOut(){
    await sb.auth.signOut();
    $('appSection').classList.add('hidden');
    $('loginSection').classList.remove('hidden');
    $('loginMsg').textContent = '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß';
    stopChatRealtime();
  }

  async function initApp(){
    const { data:{ user } } = await sb.auth.getUser();
    if(!user){ $('loginMsg').textContent='‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'; return; }

    const { data: profile, error } =
      await sb.from('profiles').select('username,is_admin').eq('id', user.id).maybeSingle();

    if (error) { showSys('‡∏î‡∏∂‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+error.message); return; }
    if (!profile || !profile.is_admin) {
      $('loginMsg').textContent='‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)';
      await sb.auth.signOut(); return;
    }

    $('adminName').textContent = '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ' + (profile.username || 'admin');
    $('btnSignOut').classList.remove('hidden');
    $('loginSection').classList.add('hidden');
    $('appSection').classList.remove('hidden');

    setTab('bookings');
    await Promise.all([loadBookings30d(), loadCustomers(), loadGallery()]);
  }

  async function autoLoginIfSession(){
    const { data:{session} } = await sb.auth.getSession();
    if (session) initApp();
  }

  function getRange30d(){
    const from = new Date(); from.setHours(0,0,0,0);
    const to = new Date(from); to.setDate(to.getDate()+30);
    $('rangeText').textContent = `‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤: ${from.toLocaleDateString('th-TH')} 00:00 - ${to.toLocaleDateString('th-TH')} 00:00`;
    return {from,to};
  }

  let profilesMap = new Map(), bookingsRaw = [], customersRaw = [];

  async function loadBookings30d(){
    const { from, to } = getRange30d();

    let q = sb.from('bookings')
      .select('id,user_id,start_at,end_at,status,slip_url,deposit_amount,total_amount,services(id,name,price),staff(display_name)')
      .gte('start_at', from.toISOString())
      .lt('start_at', to.toISOString())
      .order('start_at', { ascending: true });

    if (filterUserId) q = q.eq('user_id', filterUserId);

    const { data: bookings, error } = await q;
    if (error) { showSys('‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏¥‡∏ß‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+error.message); return; }
    bookingsRaw = bookings || [];

    const uids = [...new Set(bookingsRaw.map(b=>b.user_id))];
    if(uids.length){
      const { data: profs } = await sb.from('profiles').select('id,username,address').in('id', uids);
      profilesMap = new Map((profs||[]).map(p=>[p.id,p]));
    }else{
      profilesMap = new Map();
    }

    renderBookings();
  }

  const statusOptions = [
    { value:'booked',     label: STATUS_LABELS.booked },
    { value:'in_service', label: STATUS_LABELS.in_service },
    { value:'paid',       label: STATUS_LABELS.paid },
  ];

  const fmtTime = iso => new Date(iso).toLocaleString('th-TH',{ day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit' });
  const badge = s => `<span class="badge ${STATUS_CLASS[s]||'b-booked'}">${STATUS_LABELS[s]||s}</span>`;

  function calcAmountsForBooking(b){
    const svcName = b.services?.name || '‚Äî';
    const svcPriceDb = Number(b.services?.price || 0);
    const svcPriceFallback = Number(PRICE_FALLBACK[svcName] || 0);
    const total = Number(b.total_amount || 0) || svcPriceDb || svcPriceFallback || 0;
    const deposit = Number(b.deposit_amount || 0) || (total>0 ? DEFAULT_DEPOSIT : 0);
    const net = Math.max(0, total - deposit);
    return { total, deposit, net, svcName };
  }

  function makeCard(b){
    const prof = profilesMap.get(b.user_id) || {};
    const name = prof.username || '‚Äî';
    const addr = prof.address || '‚Äî';
    const svc  = b.services?.name || '‚Äî';
    const stf  = b.staff?.display_name || '‚Äî';

    const amt = calcAmountsForBooking(b);

    const sel = `
      <select data-bid="${b.id}" class="statusSel">
        ${statusOptions.map(op=>`<option value="${op.value}" ${op.value===b.status?'selected':''}>${op.label}</option>`).join('')}
      </select>
    `;

    const chatBtn = `<button class="btn btn-ghost" type="button" onclick="openChatTabAndWith('${b.user_id}','${(name||'‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ').replace(/'/g,'\\&#39;')}')">‡πÅ‡∏ä‡∏ó</button>`;

    const slipPart = b.slip_url
      ? `<button class="btn btn-ghost" type="button" onclick="window.open('${b.slip_url}','_blank')">‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ</button>`
      : `<span class="muted" style="font-size:12px">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡πÇ‡∏≠‡∏ô</span>`;

    const priceLine = (amt.total>0)
      ? `<div class="kv"><div class="k">‡∏£‡∏≤‡∏Ñ‡∏≤</div><div class="v">${money(amt.total)} <span class="muted small"> (‡∏°‡∏±‡∏î‡∏à‡∏≥ ${money(amt.deposit)} / ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ ${money(amt.net)})</span></div></div>`
      : `<div class="kv"><div class="k">‡∏£‡∏≤‡∏Ñ‡∏≤</div><div class="v muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤</div></div>`;

    return `
      <div class="booking-card" data-bid="${b.id}">
        <div class="card-head">
          <div class="card-time">${fmtTime(b.start_at)}</div>
          <div class="badge-wrap">${badge(b.status)}</div>
        </div>
        <div class="card-body">
          <div class="kv"><div class="k">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div><div class="v">${name}</div></div>
          <div class="kv"><div class="k">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</div><div class="v">${svc}</div></div>
          ${priceLine}
          <div class="kv"><div class="k">‡∏ä‡πà‡∏≤‡∏á</div><div class="v">${stf}</div></div>
          <div class="kv"><div class="k">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</div><div class="v" style="font-weight:500;color:#374151">${addr}</div></div>
        </div>
        <div class="card-foot">
          <div class="row" style="gap:8px">
            <div class="muted" style="font-size:12px">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
            ${sel}
          </div>
          <div class="row" style="gap:8px">
            ${slipPart}
            ${chatBtn}
          </div>
        </div>
      </div>
    `;
  }

  function renderBookings(){
    const q = ($('searchBooking').value||'').toLowerCase();

    const filtered = (bookingsRaw||[]).filter(b=>{
      const prof = profilesMap.get(b.user_id) || {};
      const name = prof.username || '';
      const addr = prof.address || '';
      const svc  = b.services?.name || '';
      const stf  = b.staff?.display_name || '';
      const okSearch = [name, svc, stf, addr].some(x => (x||'').toLowerCase().includes(q));
      const okFilter = filterUserId ? (b.user_id === filterUserId) : true;
      return okSearch && okFilter;
    });

    const listBooked = filtered.filter(b => b.status === 'booked');
    const listInSrv  = filtered.filter(b => b.status === 'in_service');
    const listPaid   = filtered.filter(b => b.status === 'paid');

    $('groupBooked').innerHTML    = listBooked.map(makeCard).join('') || `<div class="muted">‚Äî ‡∏ß‡πà‡∏≤‡∏á ‚Äî</div>`;
    $('groupInService').innerHTML = listInSrv.map(makeCard).join('')  || `<div class="muted">‚Äî ‡∏ß‡πà‡∏≤‡∏á ‚Äî</div>`;
    $('groupPaid').innerHTML      = listPaid.map(makeCard).join('')   || `<div class="muted">‚Äî ‡∏ß‡πà‡∏≤‡∏á ‚Äî</div>`;

    $('countBooked').textContent    = `${listBooked.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
    $('countInService').textContent = `${listInSrv.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
    $('countPaid').textContent      = `${listPaid.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
  }

  async function ensurePaymentRecorded(bookingId){
    const { data:{ user } } = await sb.auth.getUser();
    if(!user) throw new Error('session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');

    const { data: b, error: bErr } = await sb
      .from('bookings')
      .select('id,user_id,start_at,status,deposit_amount,total_amount,services(id,name,price)')
      .eq('id', bookingId)
      .maybeSingle();

    if (bErr) throw bErr;
    if (!b) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö booking');

    const amt = calcAmountsForBooking(b);

    const payload = {
      booking_id: b.id,
      user_id: b.user_id,
      service_id: b.services?.id || null,
      service_name: amt.svcName || (b.services?.name || '‚Äî'),
      total_amount: amt.total,
      deposit_amount: amt.deposit,
      net_amount: amt.net,
      paid_at: new Date().toISOString(),
    };

    const { error: upErr } = await sb
      .from('payments')
      .upsert(payload, { onConflict: 'booking_id' });

    if (upErr) throw upErr;
  }

  async function onChangeStatus(bookingId, newStatus){
    try{
      if (newStatus === 'paid'){
        await ensurePaymentRecorded(bookingId);
      }

      const { error } = await sb.from('bookings').update({ status: newStatus }).eq('id', bookingId);
      if(error){ toast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+error.message, false); return; }

      bookingsRaw = bookingsRaw.map(b => b.id===bookingId ? ({...b, status:newStatus}) : b);
      renderBookings();
      toast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');

      if (newStatus === 'paid') await loadPayments12m();
    }catch(e){
      toast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+(e?.message||e), false);
      console.error(e);
    }
  }

  async function loadCustomers(){
    const { data: rows } = await sb.from('profiles').select('id,username,is_admin,created_at').order('created_at', { ascending:false });
    customersRaw = rows || []; renderCustomers();
  }

  function renderCustomers(){
    const q = ($('searchCustomer').value||'').toLowerCase();
    const rows = (customersRaw||[])
      .filter(p => (p.username||'').toLowerCase().includes(q))
      .map(p => `
        <tr>
          <td>${p.username||'‚Äî'}</td>
          <td>${p.is_admin?'Admin':'User'}</td>
          <td>${new Date(p.created_at).toLocaleDateString('th-TH')}</td>
          <td>
            <div class="row">
              <button class="btn" onclick="viewUserBookings('${p.id}')">‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
              <button class="btn btn-ghost" onclick="openChatTabAndWith('${p.id}','${(p.username||'‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ').replace(/'/g,'\\&#39;')}')">‡πÅ‡∏ä‡∏ó</button>
            </div>
          </td>
        </tr>
      `).join('');
    $('customerRows').innerHTML = rows || `<tr><td colspan="4" class="muted">‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Äî</td></tr>`;
  }

  window.viewUserBookings = async (uid) => {
    filterUserId = uid;
    setTab('bookings');
    await loadBookings30d();
    toast('‡∏Å‡∏£‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß');
  };

  /* ======================= Payments/Sales ======================= */
  function pad2(n){ return String(n).padStart(2,'0'); }
  function monthKey(date){
    const d = new Date(date);
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
  }
  function monthLabel(key){
    const [y,m] = key.split('-').map(Number);
    const d = new Date(y, m-1, 1);
    return d.toLocaleDateString('th-TH', { year:'numeric', month:'long' });
  }

  function initMonthPicker(){
    const sel = $('monthPick');
    const now = new Date();
    const keys = [];
    for(let i=0;i<12;i++){
      const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
      keys.push(monthKey(d));
    }
    sel.innerHTML = keys.map(k=>`<option value="${k}">${monthLabel(k)}</option>`).join('');
  }

  async function loadPayments12m(){
    const sel = $('monthPick');
    if (!sel.value) initMonthPicker();

    const oldestKey = sel.options[sel.options.length-1].value;
    const [oy,om] = oldestKey.split('-').map(Number);
    const start = new Date(oy, om-1, 1, 0,0,0,0);

    $('salesRows').innerHTML = `<tr><td colspan="3" class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>`;

    const { data: rows, error } = await sb
      .from('payments')
      .select('id,booking_id,service_name,paid_at,total_amount,deposit_amount,net_amount')
      .gte('paid_at', start.toISOString())
      .order('paid_at', { ascending:false })
      .limit(5000);

    if (error){
      $('salesRows').innerHTML = `<tr><td colspan="3" class="muted" style="color:#b91c1c">‡πÇ‡∏´‡∏•‡∏î payments ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${escapeHtml(error.message)}</td></tr>`;
      toast('‡πÇ‡∏´‡∏•‡∏î payments ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á payments + RLS policy ‡πÅ‡∏•‡πâ‡∏ß)', false);
      return;
    }

    paymentsRaw = rows || [];
    $('paymentsCount').textContent = `${paymentsRaw.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
    renderPaymentsDashboard();
  }

  function renderPaymentsDashboard(){
    const picked = $('monthPick').value;
    const monthly = new Map();
    const byServicePicked = new Map();

    for(const p of (paymentsRaw||[])){
      const key = monthKey(p.paid_at);
      if (!monthly.has(key)) monthly.set(key, { count:0, net:0 });
      const m = monthly.get(key);
      m.count += 1;
      m.net += Number(p.net_amount||0);

      if (key === picked){
        const svc = p.service_name || '‚Äî';
        if (!byServicePicked.has(svc)) byServicePicked.set(svc, { count:0, net:0 });
        const s = byServicePicked.get(svc);
        s.count += 1;
        s.net += Number(p.net_amount||0);
      }
    }

    const sel = $('monthPick');
    const keys = [...sel.options].map(o=>o.value);

    const rowsHtml = keys.map(k=>{
      const m = monthly.get(k) || {count:0, net:0};
      const isPicked = (k===picked);
      return `
        <tr style="${isPicked?'outline:2px solid #00acc1; outline-offset:-2px':''}">
          <td>${monthLabel(k)}</td>
          <td>${m.count}</td>
          <td><b>${money(m.net)}</b></td>
        </tr>
      `;
    }).join('');

    $('salesRows').innerHTML = rowsHtml || `<tr><td colspan="3" class="muted">‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Äî</td></tr>`;

    const pickedAgg = monthly.get(picked) || {count:0, net:0};
    $('kpiNet').textContent = money(pickedAgg.net);
    $('kpiBills').textContent = String(pickedAgg.count);
    $('kpiHint').textContent = pickedAgg.count ? `‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ô ${monthLabel(picked)}` : `‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô ${monthLabel(picked)}`;

    const top = [...byServicePicked.entries()]
      .map(([name, v])=>({name, ...v}))
      .sort((a,b)=> (b.count-a.count) || (b.net-a.net))
      .slice(0, 12);

    $('topSvcCount').textContent = `${top.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

    $('topServiceRows').innerHTML = top.length
      ? top.map(x=>`
          <tr>
            <td>${escapeHtml(x.name)}</td>
            <td>${x.count}</td>
            <td><b>${money(x.net)}</b></td>
          </tr>
        `).join('')
      : `<tr><td colspan="3" class="muted">‚Äî ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Äî</td></tr>`;
  }

  /* ======================= Reviews ======================= */
  function stars(n){
    const v = Math.max(0, Math.min(5, Number(n)||0));
    return '‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ'.slice(0,v) + '‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ'.slice(0,5-v);
  }

  const fmtReviewTime = iso => {
    const d = new Date(iso);
    return d.toLocaleString('th-TH', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
  };

  async function loadReviews(){
    $('reviewsGrid').innerHTML = `<div class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>`;
    const { data: rows, error } = await sb
      .from('reviews')
      .select('id,username,comment,rating,created_at,review_images(public_url,storage_path,id)')
      .order('created_at', { ascending:false })
      .limit(200);

    if (error) {
      $('reviewsGrid').innerHTML = `<div class="muted" style="color:#b91c1c">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}</div>`;
      return;
    }
    reviewsRaw = rows || [];
    $('reviewsCount').textContent = `${reviewsRaw.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
    renderReviews();
  }

  function renderReviews(){
    const q = ($('searchReviews').value||'').toLowerCase().trim();
    const filtered = (reviewsRaw||[]).filter(r=>{
      const name = (r.username||'').toLowerCase();
      const com  = (r.comment||'').toLowerCase();
      return !q || name.includes(q) || com.includes(q);
    });

    $('reviewsCount').textContent = `${filtered.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

    if (!filtered.length) {
      $('reviewsGrid').innerHTML = `<div class="muted">‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß ‚Äî</div>`;
      return;
    }

    $('reviewsGrid').innerHTML = filtered.map(r=>{
      const imgs = Array.isArray(r.review_images) ? r.review_images : [];
      const imgHtml = imgs.slice(0,6).map(x=>`<img src="${x.public_url}" alt="">`).join('');
      return `
        <div class="review-card">
          <div class="review-head">
            <div>
              <div class="review-name">${escapeHtml(r.username||'‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ')}</div>
              <div class="review-meta">${fmtReviewTime(r.created_at)} ‚Ä¢ id: ${escapeHtml(r.id)}</div>
            </div>
            <button class="btn btn-danger" data-action="deleteReview" data-rid="${escapeHtml(r.id)}" type="button">‡∏•‡∏ö</button>
          </div>

          <div class="stars">${stars(r.rating)}</div>
          <div class="review-comment">${escapeHtml(r.comment||'')}</div>

          ${imgs.length ? `<div class="review-imgs">${imgHtml}</div>` : `<div class="muted" style="font-size:12px">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÅ‡∏ô‡∏ö</div>`}
        </div>
      `;
    }).join('');
  }

  async function deleteReview(reviewId){
    if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ô‡∏µ‡πâ?')) return;

    try{
      const { data: imgs, error: imgSelErr } = await sb
        .from('review_images')
        .select('id,storage_path')
        .eq('review_id', reviewId);

      if (imgSelErr) throw imgSelErr;

      if (imgs && imgs.length){
        const paths = imgs.map(x=>x.storage_path).filter(Boolean);
        if (paths.length){
          const { error: rmErr } = await sb.storage.from('reviews').remove(paths);
          if (rmErr) console.warn('‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå storage ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', rmErr.message);
        }

        const { data: imgDeleted, error: imgDelErr } = await sb
          .from('review_images')
          .delete()
          .eq('review_id', reviewId)
          .select('id');

        if (imgDelErr) throw imgDelErr;
        if (Array.isArray(imgDeleted) && imgDeleted.length === 0 && imgs.length > 0) {
          toast('‡∏•‡∏ö‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡∏û‡∏≠/RLS ‡∏ö‡∏•‡πá‡∏≠‡∏Å)', false);
          return;
        }
      }

      const { data: revDeleted, error: revDelErr } = await sb
        .from('reviews')
        .delete()
        .eq('id', reviewId)
        .select('id');

      if (revDelErr) throw revDelErr;

      if (!Array.isArray(revDeleted) || revDeleted.length === 0) {
        toast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö ‡∏´‡∏£‡∏∑‡∏≠ RLS ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï', false);
        return;
      }

      toast('‡∏•‡∏ö‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ');
      await loadReviews();

    }catch(e){
      toast('‡∏•‡∏ö‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (e?.message || e), false);
      console.error(e);
    }
  }

  /* ======================= Gallery ======================= */
  function initGalleryUI(){
    const sel = $('galleryCategory');
    sel.innerHTML = GALLERY_CATEGORIES.map(c=>`<option value="${c.id}">${c.label}</option>`).join('');
    galleryCategoryId = sel.value;
  }

  async function loadGallery(){
    $('galleryStatus').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
    const { data, error } = await sb
      .from('gallery_images')
      .select('id,category,public_url,storage_path,created_at')
      .eq('category', galleryCategoryId)
      .order('created_at', { ascending:false });

    if (error) {
      $('galleryStatus').textContent = '‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      toast('‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+error.message, false);
      return;
    }
    galleryItems = data || [];
    $('galleryStatus').textContent = `${galleryItems.length} ‡∏£‡∏π‡∏õ‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ`;
    renderGallery();
  }

  function renderGallery(){
    const box = $('galleryGrid');
    if (!galleryItems.length){
      box.innerHTML = '<div class="muted">‚Äî ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ ‚Äî</div>';
      return;
    }
    box.innerHTML = galleryItems.map(img=>{
      const sp = img.storage_path || '';
      return `
        <div class="g-item">
          <img src="${img.public_url}" alt="">
          <button class="btn btn-ghost" type="button"
            onclick="deleteGalleryImage('${img.id}','${sp}')">‡∏•‡∏ö</button>
        </div>
      `;
    }).join('');
  }

  async function uploadGalleryImages(){
    const input = $('galleryFile');
    const files = input.files;
    if (!files || !files.length){
      toast('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô', false); return;
    }
    const bucket = 'gallery';
    $('galleryStatus').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...';

    for (const file of files){
      const path = `${galleryCategoryId}/${Date.now()}_${file.name}`;
      const { error: upErr } = await sb.storage.from(bucket).upload(path, file);
      if (upErr){
        toast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+upErr.message, false);
        continue;
      }
      const { data: urlData } = sb.storage.from(bucket).getPublicUrl(path);
      const publicUrl = urlData.publicUrl;

      const { error: dbErr } = await sb.from('gallery_images').insert({
        category: galleryCategoryId,
        storage_path: path,
        public_url: publicUrl,
      });
      if (dbErr){
        toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+dbErr.message, false);
      }
    }

    input.value = '';
    toast('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß');
    await loadGallery();
  }

  window.deleteGalleryImage = async (id, storagePath)=>{
    if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ?')) return;
    const bucket = 'gallery';

    const { error: sErr } = await sb.storage.from(bucket).remove([storagePath]);
    if (sErr){
      toast('‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å Storage ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+sErr.message, false);
      return;
    }
    const { error: dErr } = await sb.from('gallery_images').delete().eq('id', id);
    if (dErr){
      toast('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+dErr.message, false);
      return;
    }
    toast('‡∏•‡∏ö‡∏£‡∏π‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    await loadGallery();
  };

  /* ======================= Chats (‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ + ‡∏Å‡∏±‡∏ô content not null) ======================= */
  let chatPeerId = null;
  let chatPeerName = '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
  let chatSubscription = null;

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
  }
  function computeChatId(a, b){ const ids=[a,b].sort(); return ids[0]+'_'+ids[1]; }
  function stopChatRealtime(){ if (chatSubscription){ chatSubscription.unsubscribe(); chatSubscription=null; } }

  function openChatTabAndWith(uid, name){
    setTab('chats');
    openChatWith(uid, name);
  }

  function onPickChatImage(e){
    const f = e.target.files && e.target.files[0];
    pendingChatImageFile = f || null;

    const hint = $('chatImageHint');
    if (pendingChatImageFile){
      hint.style.display = 'block';
      hint.textContent = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß: ${pendingChatImageFile.name} (‡∏Å‡∏î‡∏™‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î)`;
    }else{
      hint.style.display = 'none';
      hint.textContent = '';
    }
  }

  async function loadConversations(){
    const { data:{ user } } = await sb.auth.getUser();
    if(!user){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà', false); return; }

    const since = new Date(); since.setDate(since.getDate()-90);

    const { data: rows, error } = await sb
      .from('messages')
      .select('chat_id,sender_id,receiver_id,content,image_url,created_at')
      .or(`sender_id.eq.${user.id},receiver_id.eq.${user.id}`)
      .gte('created_at', since.toISOString())
      .order('created_at', { ascending:false });

    if (error){
      $('chatListItems').innerHTML = '<div class="muted" style="padding:12px">‡πÇ‡∏´‡∏•‡∏î‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>';
      return;
    }

    const byPeer = new Map();
    for(const m of (rows||[])){
      const peer = (m.sender_id===user.id) ? m.receiver_id : m.sender_id;
      if (!byPeer.has(peer)) byPeer.set(peer, m);
    }

    const peers = [...byPeer.keys()];
    let nameMap = new Map();
    if (peers.length){
      const { data: profs } = await sb.from('profiles').select('id,username').in('id', peers);
      nameMap = new Map((profs||[]).map(p=>[p.id, p.username||'‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ']));
    }

    const items = peers.map(pid=>{
      const m = byPeer.get(pid);
      const name = nameMap.get(pid) || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
      const time = new Date(m.created_at).toLocaleString('th-TH',{ month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
      const snippet = (m.image_url ? '[‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û]' : (m.content||'')).toString();
      const selected = (pid===chatPeerId) ? ' selected' : '';
      return `
        <div class="cl-item${selected}" onclick="openChatWith('${pid}','${(name).replace(/'/g,'\\&#39;')}')">
          <div>
            <div class="cl-name">${escapeHtml(name)}</div>
            <div class="cl-snippet">${escapeHtml(snippet)}</div>
          </div>
          <div class="cl-time">${time}</div>
        </div>
      `;
    }).join('');

    $('chatListItems').innerHTML = items || '<div class="muted" style="padding:12px">‚Äî ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤ ‚Äî</div>';
  }

  async function openChatWith(peerId, peerName='‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'){
    try{
      const { data:{ user } } = await sb.auth.getUser();
      if(!user){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà', false); return; }

      chatPeerId = peerId; chatPeerName = peerName;
      $('chatTitle').textContent = `‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ö: ${peerName}`;
      $('chatHeaderRight').textContent = '';

      document.querySelectorAll('.cl-item').forEach(el=>el.classList.remove('selected'));
      const idx = [...document.querySelectorAll('.cl-item')].find(el => el.getAttribute('onclick')?.includes(peerId));
      if (idx) idx.classList.add('selected');

      stopChatRealtime();
      const chatId = computeChatId(user.id, peerId);

      const { data: rows, error } = await sb
        .from('messages')
        .select('*')
        .eq('chat_id', chatId)
        .order('created_at', { ascending: true });

      if (error) { $('chatMessages').innerHTML = '<div class="muted" style="padding:12px">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>'; return; }
      renderChatRows(rows || [], user.id);

      chatSubscription = sb
        .channel('realtime:messages:'+chatId)
        .on('postgres_changes',
          { event: 'INSERT', schema: 'public', table: 'messages', filter: `chat_id=eq.${chatId}` },
          payload => appendChatRow(payload.new, user.id)
        ).subscribe();

    }catch(e){
      console.error(e);
      toast('‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false);
    }
  }

  function renderChatRows(rows, myId){
    const box = $('chatMessages');
    if(!rows.length){ box.innerHTML = '<div class="muted" style="padding:12px">‚Äî ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‚Äî</div>'; return; }

    box.innerHTML = rows.map(m=>{
      const mine = m.sender_id === myId;
      const text = (m.content||'');
      const img  = (m.image_url||'');
      const hasImg = !!img;

      return `
        <div style="display:flex; ${mine?'justify-content:flex-end':'justify-content:flex-start'}; margin:6px 0;">
          <div style="max-width:78%; padding:8px 12px; border-radius:12px; background:${mine?'#00acc1':'#e5e7eb'}; color:${mine?'#fff':'#111'}; white-space:pre-wrap; word-break:break-word;">
            ${hasImg ? `<img class="chat-img" src="${img}" onclick="window.open('${img}','_blank')" alt="">` : ``}
            ${hasImg && text ? `<div style="height:6px"></div>` : ``}
            ${text ? escapeHtml(text) : ``}
          </div>
        </div>
      `;
    }).join('');

    box.scrollTop = box.scrollHeight;
  }

  function appendChatRow(m, myId){
    const box = $('chatMessages');
    if (box.innerHTML.includes('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°')) box.innerHTML = '';
    const mine = m.sender_id === myId;

    const text = (m.content||'');
    const img  = (m.image_url||'');
    const hasImg = !!img;

    const html = `
      <div style="display:flex; ${mine?'justify-content:flex-end':'justify-content:flex-start'}; margin:6px 0;">
        <div style="max-width:78%; padding:8px 12px; border-radius:12px; background:${mine?'#00acc1':'#e5e7eb'}; color:${mine?'#fff':'#111'}; white-space:pre-wrap; word-break:break-word;">
          ${hasImg ? `<img class="chat-img" src="${img}" onclick="window.open('${img}','_blank')" alt="">` : ``}
          ${hasImg && text ? `<div style="height:6px"></div>` : ``}
          ${text ? escapeHtml(text) : ``}
        </div>
      </div>`;
    box.insertAdjacentHTML('beforeend', html);
    box.scrollTop = box.scrollHeight;
    loadConversations();
  }

  async function uploadChatImageAndGetUrl(chatId, file){
    const { data:{ user } } = await sb.auth.getUser();
    if(!user) throw new Error('session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');

    // ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå
    const ext = (file.name && file.name.includes('.')) ? file.name.split('.').pop() : 'jpg';
    const safeExt = String(ext || 'jpg').replace(/[^a-zA-Z0-9]/g,'').slice(0,10) || 'jpg';

    // ‚ö†Ô∏è bucket ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠ "chat"
    const path = `${chatId}/${Date.now()}_${user.id}.${safeExt}`;

    const { error: upErr } = await sb.storage.from('chat').upload(path, file, {
      contentType: file.type || 'image/jpeg',
      upsert: false
    });
    if (upErr) throw upErr;

    const { data: urlData } = sb.storage.from('chat').getPublicUrl(path);
    return { publicUrl: urlData.publicUrl, path };
  }

  async function sendChat(){
    const txt = ($('chatInput').value||'').trim();
    const imgFile = pendingChatImageFile;

    if(!txt && !imgFile) return;

    const { data:{ user } } = await sb.auth.getUser();
    if(!user || !chatPeerId){ toast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó', false); return; }

    const chatId = computeChatId(user.id, chatPeerId);

    $('btnSend').disabled = true;

    try{
      let imageUrl = null;

      if (imgFile){
        const uploaded = await uploadChatImageAndGetUrl(chatId, imgFile);
        imageUrl = uploaded.publicUrl;
      }

      // clear ui
      $('chatInput').value = '';
      pendingChatImageFile = null;
      $('chatImage').value = '';
      $('chatImageHint').style.display = 'none';
      $('chatImageHint').textContent = '';

      // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: content ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô null (‡∏Å‡∏±‡∏ô not null constraint)
      const payload = {
        chat_id: chatId,
        sender_id: user.id,
        receiver_id: chatPeerId,
        content: txt || '',  // <-- FIX ‡∏´‡∏•‡∏±‡∏Å
        msg_type: (imageUrl ? (txt ? 'mixed' : 'image') : 'text'),
        image_url: imageUrl
      };

      const { error } = await sb.from('messages').insert(payload);
      if (error) toast('‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+error.message, false);
    }catch(e){
      console.error(e);
      toast('‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ/‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e?.message||e), false);
    }finally{
      $('btnSend').disabled = false;
    }
  }
</script>
</body>
</html>
