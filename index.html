<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard</title>
  <style>
    :root{--teal:#00acc1;--bg:#f6f8fa;--card:#fff;--text:#111;--muted:#6b7280;--ok:#10b981;--warn:#f59e0b;--err:#ef4444}
    *{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    body{margin:0;background:var(--bg);color:var(--text)}
    header{display:flex;gap:12px;justify-content:space-between;align-items:center;padding:16px 20px;background:var(--teal);color:#fff}
    .wrap{max-width:1100px;margin:18px auto;padding:0 14px}
    .card{background:var(--card);border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:16px;margin-bottom:16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .btn{border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn-ghost{background:#eef3f6;color:#111}
    input, select{padding:10px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#fff}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{padding:10px 12px;text-align:left;vertical-align:middle}
    th{color:#374151;font-size:13px}
    tr{background:#fff}
    tr td:first-child,tr th:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    tr td:last-child,tr th:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    .muted{color:var(--muted)} .hidden{display:none}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:5px 9px;border-radius:999px;font-size:12px}
    /* เดิม */
    .b-pending{background:#fff7ed;color:#b45309}.b-confirmed{background:#ecfdf5;color:#065f46}.b-cancelled{background:#fef2f2;color:#b91c1c}.b-completed{background:#eef2ff;color:#3730a3}
    /* ใหม่สำหรับ 3 สถานะ */
    .b-booked{background:#fff7ed;color:#b45309}
    .b-in_service{background:#eef2ff;color:#3730a3}
    .b-paid{background:#ecfdf5;color:#065f46}
    .tabs{display:flex;gap:8px;margin-bottom:8px}.tabs button{padding:8px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}.tabs button.active{background:var(--teal);color:#fff;border-color:var(--teal)}
    .login{max-width:420px;margin:40px auto}
    #sysMsg{margin:10px 0;color:#b91c1c;font-size:13px}
    #toast{position:fixed;right:16px;bottom:16px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transition:opacity .25s}
    #toast.show{opacity:1}
  </style>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
</head>
<body>
<header>
  <div class="row">
    <strong>Admin Dashboard</strong>
    <span id="adminName" class="muted"></span>
  </div>
  <div class="row">
    <button id="btnSignOut" class="btn btn-ghost hidden" type="button">ออกจากระบบ</button>
  </div>
</header>

<div class="wrap">
  <!-- LOGIN -->
  <div id="loginSection" class="card login">
    <h3 style="margin:0 0 10px 0;">เข้าสู่ระบบแอดมิน</h3>
    <p class="muted" style="margin-top:0">กรอกอีเมล/รหัสผ่านบัญชีแอดมิน</p>
    <div id="sysMsg" class="hidden"></div>
    <div class="row">
      <input id="email" type="email" placeholder="อีเมล" style="flex:1 1 220px" />
      <input id="password" type="password" placeholder="รหัสผ่าน" style="flex:1 1 180px" />
      <button id="btnLogin" class="btn btn-ghost" type="button">เข้าสู่ระบบ</button>
    </div>
    <p id="loginMsg" class="muted" style="margin-top:10px"></p>
  </div>

  <!-- APP -->
  <div id="appSection" class="hidden">
    <div class="tabs">
      <button id="tabBookings" class="active" type="button">คิวช่วง 30 วัน</button>
      <button id="tabCustomers" type="button">ลูกค้าในระบบ</button>
    </div>

    <section id="bookingsPanel" class="card">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">คิวช่วง 30 วัน</h3>
        <div class="row">
          <input id="searchBooking" placeholder="ค้นหา: ลูกค้า/บริการ/ช่าง" />
          <button id="btnReload" class="btn btn-ghost" type="button">รีเฟรช</button>
        </div>
      </div>
      <div style="height:10px"></div>
      <div class="muted" id="rangeText"></div>
      <div style="height:10px"></div>
      <div class="card">
        <table>
          <thead>
            <tr>
              <th>เวลา</th>
              <th>ลูกค้า</th>
              <th>บริการ</th>
              <th>ช่าง</th>
              <th>สถานะ</th>
              <th>เปลี่ยนสถานะ</th>
            </tr>
          </thead>
          <tbody id="bookingRows"></tbody>
        </table>
      </div>
    </section>

    <section id="customersPanel" class="card hidden">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">ลูกค้าในระบบ</h3>
        <input id="searchCustomer" placeholder="ค้นหา: ชื่อผู้ใช้" />
      </div>
      <div style="height:10px"></div>
      <div class="card">
        <table>
          <thead>
            <tr><th>ผู้ใช้</th><th>สิทธิ์</th><th>สมัครเมื่อ</th></tr>
          </thead>
          <tbody id="customerRows"></tbody>
        </table>
      </div>
    </section>
  </div>
</div>

<div id="toast"></div>

<script>
  // ====== ใส่ค่าจริงของคุณตรงนี้ ======
  const SUPABASE_URL = 'https://cnvrzvqpnvogbibrxhnh.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNudnJ6dnFwbnZvZ2JpYnJ4aG5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NjMzNTAsImV4cCI6MjA3MDAzOTM1MH0.HI92YCd9UF8Nzn0Lq-uWGF21Iz7zqwAHY6PBesQ4cu4';

  // ====== Utilities ======
  const $ = (id)=>document.getElementById(id);
  const sysBox = $('sysMsg');
  const showSys = (msg)=>{ sysBox.textContent = msg; sysBox.classList.remove('hidden'); };
  const hideSys = ()=>{ sysBox.classList.add('hidden'); };
  const toast = (msg, ok=true)=>{
    const el = $('toast');
    el.textContent = msg;
    el.style.background = ok ? 'rgba(17,17,17,.9)' : '#b91c1c';
    el.classList.add('show');
    setTimeout(()=>el.classList.remove('show'), 2000);
  };

  // แผนที่สถานะ (โค้ด <-> ป้ายภาษาไทย/คลาส)
  const STATUS_LABELS = { booked:'จองแล้ว', in_service:'ลูกค้าเข้าใช้บริการ', paid:'ลูกค้าชำระเงินแล้ว' };
  const STATUS_CLASS  = { booked:'b-booked', in_service:'b-in_service', paid:'b-paid',
                          pending:'b-pending', confirmed:'b-confirmed', cancelled:'b-cancelled', completed:'b-completed' };

  let sb = null;

  // รอให้ <script defer> โหลดเสร็จก่อน
  window.addEventListener('DOMContentLoaded', () => {
    try {
      if (!window.supabase) { showSys('โหลดไลบรารีไม่สำเร็จ (CDN) — กรุณารีเฟรชหน้าอีกครั้ง'); return; }
      if (!SUPABASE_URL.startsWith('http') || SUPABASE_ANON_KEY.includes('YOUR-')) { showSys('ยังไม่ได้ตั้งค่า SUPABASE_URL / ANON_KEY ในไฟล์ admin.html'); return; }
      sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      bindEvents();
      autoLoginIfSession();
    } catch (e) {
      console.error(e);
      showSys('ตั้งค่า Supabase ไม่สำเร็จ: ' + e.message);
    }
  });

  function bindEvents(){
    $('btnLogin').addEventListener('click', onLogin);
    $('btnSignOut').addEventListener('click', onSignOut);
    $('tabBookings').addEventListener('click', ()=>setTab('bookings'));
    $('tabCustomers').addEventListener('click', ()=>setTab('customers'));
    $('btnReload').addEventListener('click', loadBookings30d);
    $('searchBooking').addEventListener('input', renderBookings);
    $('searchCustomer').addEventListener('input', renderCustomers);
  }

  async function onLogin(){
    hideSys();
    const email = $('email').value.trim();
    const pass  = $('password').value;
    if (!sb) { showSys('ยังไม่ได้ตั้งค่า Supabase'); return; }
    if (!email || !pass) { $('loginMsg').textContent = 'กรอกอีเมล/รหัสผ่านก่อน'; return; }
    $('loginMsg').textContent = 'กำลังเข้าสู่ระบบ...';
    const { error } = await sb.auth.signInWithPassword({ email, password: pass });
    if (error) { $('loginMsg').textContent = 'เข้าสู่ระบบไม่สำเร็จ: ' + error.message; return; }
    await initApp();
  }

  async function onSignOut(){
    await sb.auth.signOut();
    $('appSection').classList.add('hidden');
    $('loginSection').classList.remove('hidden');
    $('loginMsg').textContent = 'ออกจากระบบแล้ว';
  }

  function setTab(which){
    if(which==='bookings'){
      $('tabBookings').classList.add('active'); $('tabCustomers').classList.remove('active');
      $('bookingsPanel').classList.remove('hidden'); $('customersPanel').classList.add('hidden');
    }else{
      $('tabCustomers').classList.add('active'); $('tabBookings').classList.remove('active');
      $('customersPanel').classList.remove('hidden'); $('bookingsPanel').classList.add('hidden');
    }
  }

  async function initApp(){
    const { data:{ user } } = await sb.auth.getUser();
    if(!user){ $('loginMsg').textContent='กรุณาเข้าสู่ระบบ'; return; }

    const { data: profile, error } =
      await sb.from('profiles').select('username,is_admin').eq('id', user.id).maybeSingle();

    if (error) { showSys('ดึงโปรไฟล์ไม่สำเร็จ: '+error.message); return; }
    if (!profile || !profile.is_admin) {
      $('loginMsg').textContent='ไม่มีสิทธิ์เข้าใช้งาน (ต้องเป็นแอดมิน)';
      await sb.auth.signOut(); return;
    }

    $('adminName').textContent = 'สวัสดี, ' + (profile.username || 'admin');
    $('btnSignOut').classList.remove('hidden');
    $('loginSection').classList.add('hidden');
    $('appSection').classList.remove('hidden');

    setTab('bookings');
    await Promise.all([loadBookings30d(), loadCustomers()]);
  }

  function getRange30d(){
    const from = new Date(); from.setHours(0,0,0,0);
    const to = new Date(from); to.setDate(to.getDate()+30);
    $('rangeText').textContent = `ช่วงเวลา: ${from.toLocaleDateString('th-TH')} 00:00 - ${to.toLocaleDateString('th-TH')} 00:00`;
    return {from,to};
  }

  let profilesMap = new Map(), bookingsRaw = [], customersRaw = [];
  const badge = s => {
    const cls = STATUS_CLASS[s] || 'b-pending';
    const th  = STATUS_LABELS[s] || s; // ถ้าเป็นค่าเก่าจะโชว์ดิบ ๆ
    return `<span class="badge ${cls}">${th}</span>`;
  };
  const fmtTime = iso => new Date(iso).toLocaleString('th-TH',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});

  async function loadBookings30d(){
    const { from, to } = getRange30d();
    const { data: bookings, error } = await sb
      .from('bookings')
      // NOTE: ดึง status ด้วย และดึง service กับ staff
      .select('id,user_id,start_at,end_at,status,services(name),staff(display_name)')
      .gte('start_at', from.toISOString()).lt('start_at', to.toISOString())
      .order('start_at', { ascending: true });
    if (error) { showSys('โหลดคิวไม่สำเร็จ: '+error.message); return; }
    bookingsRaw = bookings || [];

    const uids = [...new Set(bookingsRaw.map(b=>b.user_id))];
    if(uids.length){
      const { data: profs } = await sb.from('profiles').select('id,username').in('id', uids);
      profilesMap = new Map((profs||[]).map(p=>[p.id,p]));
    }else{
      profilesMap = new Map();
    }
    renderBookings();
  }

  // ตัวเลือกสถานะใน select
  const statusOptions = [
    { value:'booked', label: STATUS_LABELS.booked },
    { value:'in_service', label: STATUS_LABELS.in_service },
    { value:'paid', label: STATUS_LABELS.paid },
  ];

  function renderBookings(){
    const q = ($('searchBooking').value||'').toLowerCase();
    const rows = (bookingsRaw||[]).filter(b=>{
      const name = profilesMap.get(b.user_id)?.username || '';
      const svc  = b.services?.name || '';
      const stf  = b.staff?.display_name || '';
      return [name,svc,stf].some(x=>x.toLowerCase().includes(q));
    }).map(b=>{
      const name = profilesMap.get(b.user_id)?.username || '—';
      const svc  = b.services?.name || '—';
      const stf  = b.staff?.display_name || '—';

      // สร้าง dropdown เปลี่ยนสถานะ (ค่าเริ่มต้น = b.status)
      const sel = `<select data-bid="${b.id}" class="statusSel">
        ${statusOptions.map(op=>`<option value="${op.value}" ${op.value===b.status?'selected':''}>${op.label}</option>`).join('')}
      </select>`;

      return `<tr>
        <td>${fmtTime(b.start_at)}</td>
        <td>${name}</td>
        <td>${svc}</td>
        <td>${stf}</td>
        <td>${badge(b.status)}</td>
        <td>${sel}</td>
      </tr>`;
    }).join('');
    $('bookingRows').innerHTML = rows || `<tr><td colspan="6" class="muted">— ไม่มีคิวในช่วงนี้ —</td></tr>`;

    // bind change events หลัง render เสร็จ
    document.querySelectorAll('.statusSel').forEach(el=>{
      el.addEventListener('change', async (e)=>{
        const bookingId = e.target.getAttribute('data-bid');
        const newStatus = e.target.value;
        await onChangeStatus(bookingId, newStatus);
      });
    });
  }

  async function onChangeStatus(bookingId, newStatus){
    try{
      const { error } = await sb.from('bookings').update({ status: newStatus }).eq('id', bookingId);
      if(error){ toast('อัปเดตสถานะไม่สำเร็จ: '+error.message, false); return; }

      // อัปเดตในหน่วยความจำและรีเรนเดอร์
      bookingsRaw = bookingsRaw.map(b => b.id===bookingId ? ({...b, status:newStatus}) : b);
      renderBookings();
      toast('อัปเดตสถานะเรียบร้อย');
    }catch(e){
      toast('เกิดข้อผิดพลาด: '+e.message, false);
    }
  }

  async function loadCustomers(){
    const { data: rows } = await sb.from('profiles').select('id,username,is_admin,created_at').order('created_at', { ascending:false });
    customersRaw = rows || []; renderCustomers();
  }
  function renderCustomers(){
    const q = ($('searchCustomer').value||'').toLowerCase();
    $('customerRows').innerHTML = customersRaw.filter(p=>(p.username||'').toLowerCase().includes(q)).map(p=>(
      `<tr><td>${p.username||'—'}</td><td>${p.is_admin?'Admin':'User'}</td><td>${new Date(p.created_at).toLocaleDateString('th-TH')}</td></tr>`
    )).join('') || `<tr><td colspan="3" class="muted">— ไม่มีข้อมูล —</td></tr>`;
  }

  async function autoLoginIfSession(){
    if (!sb) return;
    const { data:{session} } = await sb.auth.getSession();
    if (session) initApp();
  }
</script>
</body>
</html>
