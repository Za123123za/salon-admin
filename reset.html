<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>รีเซ็ตรหัสผ่าน</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f6f8fa;margin:0}
    .wrap{max-width:480px;margin:40px auto;padding:16px}
    .card{background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:20px}
    h2{margin:0 0 10px 0}
    .muted{color:#6b7280}
    input,button{width:100%;padding:12px;border-radius:10px;border:1px solid #e5e7eb;margin:8px 0}
    button{background:#00acc1;color:#fff;border:0;font-weight:700;cursor:pointer}
    #msg{margin-top:8px;font-size:14px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>ตั้งรหัสผ่านใหม่</h2>
      <p class="muted">กรอกรหัสผ่านใหม่ 2 ครั้ง แล้วกดยืนยัน</p>
      <input id="pass1" type="password" placeholder="รหัสผ่านใหม่" />
      <input id="pass2" type="password" placeholder="ยืนยันรหัสผ่านใหม่" />
      <button id="btn">ยืนยันการเปลี่ยนรหัสผ่าน</button>
      <div id="msg" class="muted"></div>
    </div>
  </div>

<script>
  // ใส่ค่าจริงจากโปรเจกต์ของคุณ
  const SUPABASE_URL = 'https://cnvrzvqpnvogbibrxhnh.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNudnJ6dnFwbnZvZ2JpYnJ4aG5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NjMzNTAsImV4cCI6MjA3MDAzOTM1MH0.HI92YCd9UF8Nzn0Lq-uWGF21Iz7zqwAHY6PBesQ4cu4';

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const $ = (id)=>document.getElementById(id);
  const say = (t, ok=true)=>{ const el=$('msg'); el.textContent=t; el.style.color=ok?'#6b7280':'#b91c1c'; };
  const btn = $('btn');

  btn.disabled = true;

  async function bootstrap() {
    try {
      const url = new URL(location.href);
      const tokenHash = url.searchParams.get('token_hash');
      const type = url.searchParams.get('type');

      if (!tokenHash || (type && type !== 'recovery')) {
        say('ลิงก์ไม่ถูกต้อง/ไม่มี token_hash กรุณากด “ลืมรหัสผ่าน” ใหม่จากแอป', false);
        return;
      }

      // ยืนยันโค้ดแบบ token_hash (ไม่ใช้ PKCE)
      const { error } = await sb.auth.verifyOtp({
        type: 'recovery',
        token_hash: tokenHash
      });
      if (error) throw error;

      const { data } = await sb.auth.getSession();
      if (!data?.session) {
        say('ยังไม่มีเซสชันจากลิงก์ กรุณาส่งลิงก์ใหม่', false);
        return;
      }

      btn.disabled = false;
      say('โปรดตั้งรหัสผ่านใหม่');
    } catch (e) {
      console.error(e);
      say('Email link is invalid or has expired', false);
    }
  }

  bootstrap();

  btn.addEventListener('click', async () => {
    const p1 = $('pass1').value.trim();
    const p2 = $('pass2').value.trim();
    if (!p1 || !p2) return say('กรุณากรอกรหัสผ่านให้ครบ', false);
    if (p1.length < 6) return say('รหัสผ่านควรยาวอย่างน้อย 6 ตัวอักษร', false);
    if (p1 !== p2) return say('รหัสผ่านทั้งสองช่องไม่ตรงกัน', false);

    try {
      const { error } = await sb.auth.updateUser({ password: p1 });
      if (error) throw error;
      say('เปลี่ยนรหัสผ่านสำเร็จ! กลับไปที่แอปแล้วเข้าสู่ระบบใหม่ได้เลย ✅');
    } catch (e) {
      console.error(e);
      say('เปลี่ยนรหัสผ่านไม่สำเร็จ: ' + (e.message || e), false);
    }
  });
</script>
</body>
</html>
